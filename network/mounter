#!/usr/bin/env python3.5

import os
import argparse
import enum
import sys
import syslog
import time
import libmount


# $ nmcli connection show
uuids = [
    '06fcce0f-607a-45c1-81b5-1772be037f3b'
]
conn_names = [
    'netqa'
]

user = 'hoefling'

network_root = os.path.join('//', 'master.qanet.local')
mount_root = os.path.join('/', 'mnt', 'master')
samba_creds = os.path.join('/', 'home', 'hoefling', '.netqa', 'smbcredentials')


########################################################################
class State(enum.Enum):
    '''Connection states'''
    up = 'up'
    down = 'down'
    pre_up = 'pre-up'
    post_down = 'post-down'
    pre_down = 'pre-down'
    vpn_up = 'vpn-up'
    vpn_down = 'vpn-down'
    vpn_pre_up = 'vpn-pre-up'
    vpn_pre_down = 'vpn-pre-down'

#----------------------------------------------------------------------
def mkcifs(source: str, target: str) -> libmount.Context:
    ''''''
    ctx = libmount.Context()
    ctx.fstype = 'cifs'
    ctx.options = (
        'rw,_netdev,user,exec,uid={user},'
        'gid={user},credentials={creds}'
    ).format(user=user, creds=samba_creds)
    ctx.source = source
    ctx.target = target
    return ctx

#----------------------------------------------------------------------
def unmounter(source: str) -> libmount.Context:
    ''''''
    ctx = libmount.Context()
    ctx.enable_force(True)
    ##ctx.enable_lazy(True)
    ctx.options = 'cifs'
    ctx.source = source
    ctx.target = source
    return ctx

#----------------------------------------------------------------------
def main():
    '''entry point'''

    syslog.syslog('mounter started ...')

    # this won't work as mount is only possible after tun0 is connected
##    if 'CONNECTION_ID' not in os.environ or os.environ['CONNECTION_ID'] not in conn_names:
##        return 0

    parser = argparse.ArgumentParser()
    parser.add_argument('connstate', nargs='+')
    args = parser.parse_args()
    if not args.connstate or len(args.connstate) < 2:
        return 1

    interface = args.connstate[0]
    state = State(args.connstate[1])

    if interface == 'tun0' and state == State.vpn_up:
        syslog.syslog('mounting network shares ...')

        mounts = [
            mkcifs(os.path.join('//', '172.16.132.1', 'Testumgebung'), os.path.join(mount_root, 'test_environment')),
            mkcifs(os.path.join('//', '172.16.132.1', 'Storage'), os.path.join(mount_root, 'storage')),
            mkcifs(os.path.join(network_root, 'testenv'), os.path.join(mount_root, 'env')),
            mkcifs(os.path.join(network_root, 'TestTools'), os.path.join(mount_root, 'testtools')),
            mkcifs(os.path.join(network_root, 'FrameWork'), os.path.join(mount_root, 'framework')),
            mkcifs(os.path.join(network_root, 'Projects'), os.path.join(mount_root, 'projects')),
            mkcifs(os.path.join(network_root, 'TestImplementation'), os.path.join(mount_root, 'test_implementation')),
            mkcifs(os.path.join(network_root, 'sphinx_docs'), os.path.join(mount_root, 'sphinx_docs')),
        ]

        try:
            for ctx in mounts:
                if not os.path.isdir(ctx.target):
                    os.makedirs(ctx.target)
                ctx.mount()
        except Exception as error:
            syslog.syslog(str(error))
        time.sleep(5)

    if interface == 'tun0' and state == State.vpn_down:
        syslog.syslog('unmounting network shares ...')
        try:
            mounts = [
                unmounter(os.path.join('//', '172.16.132.1', 'Testumgebung')),
                unmounter(os.path.join('//', '172.16.132.1', 'Storage')),
                unmounter(os.path.join(network_root, 'testenv')),
                unmounter(os.path.join(network_root, 'TestTools')),
                unmounter(os.path.join(network_root, 'FrameWork')),
                unmounter(os.path.join(network_root, 'Projects')),
                unmounter(os.path.join(network_root, 'TestImplementation')),
                unmounter(os.path.join(network_root, 'sphinx_docs')),
            ]
            for ctx in mounts:
                ctx.umount()
        except Exception as error:
            syslog.syslog(str(error))
        time.sleep(5)

    syslog.syslog('mounter finished')
    return 0


if __name__ == '__main__':
    sys.exit(main())
